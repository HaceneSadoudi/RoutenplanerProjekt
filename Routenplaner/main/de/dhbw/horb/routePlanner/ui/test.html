<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" lang="en"></meta>
  <title>OSM3S on Mapnik via Open Layers</title>
  <script src="OpenLayers.js"></script>
  <script src="http://www.openstreetmap.org/openlayers/OpenStreetMap.js"></script>
  <script src="http://overpass-api.de/overpass.js"></script>
  <script type="text/javascript">
	  
	  var lat = 53.86;
      var lon = 8.44;
      var zoom = 18;
	  var map;

      DetectBoundsOSMFormat = OpenLayers.Class(OpenLayers.Format.OSM, {

          min_lat: 180.0,
          max_lat: -180.0,
          min_lon: 90.0,
          max_lon: -90.0,
          zoom: 0,

          getNodes: function(doc)
          {
            var node_list = doc.getElementsByTagName("node");
            var nodes = {};
            for (var i = 0; i < node_list.length; i++)
            {
              var node = node_list[i];
              var id = node.getAttribute("id");
              nodes[id] = {
                'lat': node.getAttribute("lat"),
                'lon': node.getAttribute("lon"),
                'node': node
              };

              if (nodes[id].lat < this.min_lat)
                this.min_lat = nodes[id].lat;
              if (nodes[id].lat > this.max_lat)
                this.max_lat = nodes[id].lat;
              if (nodes[id].lon < this.min_lon)
                this.min_lon = nodes[id].lon;
              if (nodes[id].lon > this.max_lon)
                this.max_lon = nodes[id].lon;
            }

            if (this.min_lat == 180.0)
            {
                this.min_lat = 0;
                this.max_lat = 0;
            }
            if (this.min_lon == 90.0)
            {
                this.min_lon = 0;
                this.max_lon = 0;
            }

            setStatusText("Result contains no nodes.");
            return nodes;
          },          

          CLASS_NAME: "DetectBoundsOSMFormat"
      });

      var osm_format = new DetectBoundsOSMFormat();
      var layer = "";

      function make_features_added_closure() {
          return function(evt) {

              var lonLat = new OpenLayers.LonLat(
                  (Number(osm_format.min_lon) + Number(osm_format.max_lon))/2.0,
                  (Number(osm_format.min_lat) + Number(osm_format.max_lat))/2.0)
                  .transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));

              var southwest = new OpenLayers.LonLat(
                  Number(osm_format.min_lon), Number(osm_format.min_lat))
                  .transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));

              var northeast = new OpenLayers.LonLat(
                  Number(osm_format.max_lon), Number(osm_format.max_lat))
                  .transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));

            map.setCenter(lonLat);

            var extent = map.getExtent();
            extent.extend(southwest);
            extent.extend(northeast);
            map.zoomToExtent(extent);

            setStatusText("Found " + layer.features.length + " features.");
          };
      }

      function init(){
	  	  
		  params1 = {data: '((way(61235011);way(61235015);way(248645768);way(26764509);way(26764510);way(156208733);way(184908983);way(177922715);way(114935109);way(26764500);way(26764501);way(26764502);way(26764503);way(249886202);way(249886201);way(195533764);way(249886200);way(61233976);way(61233983);way(195533929);way(26764438);way(26764439);way(25016730);way(25016731);way(25016995);way(25016996);way(270896191);way(60799284);way(60799263);way(270896193);way(26741036);way(26741037);way(26741038);way(26741039);way(192764502);way(60799244);way(4018378);way(235985591);way(270896192);way(60799279);way(60799245);way(270896189);way(12315746);way(6244752);way(204101525);way(204101527);way(270896190);way(60799255);way(60799283);way(270896194);way(36778227);way(36778229);way(36778231);way(36778234);way(272812755);way(272812761);way(272812759);way(272812760);way(230183155);way(60470591);way(272812758);way(60470609);way(60470601);way(272716882);way(272716881);way(60470595);way(272716879);way(60467276);way(60467273);way(272716877);way(6244754);way(4734822);way(144840764);way(26740976);way(44016323);way(44016324);way(243365126););>;);out body;'};
		  
          map = new OpenLayers.Map ("map", {
          controls:[
              new OpenLayers.Control.Navigation(),
              new OpenLayers.Control.PanZoomBar(),
              new OpenLayers.Control.LayerSwitcher(),
              new OpenLayers.Control.Attribution()],
              maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
              maxResolution: 156543.0399,
              numZoomLevels: 19,
              units: 'm',
              projection: new OpenLayers.Projection("EPSG:900913"),
              displayProjection: new OpenLayers.Projection("EPSG:4326")
          } );

          layerMapnik = new OpenLayers.Layer.OSM.Mapnik("Mapnik");
          map.addLayer(layerMapnik);

          var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));

          map.setCenter (lonLat, zoom);

          //Initialise the vector layer using OpenLayers.Format.OSM -> layer
          var styleMap = new OpenLayers.StyleMap({
              strokeColor: "rgb(255, 0, 255)",
              strokeOpacity: 0.5,
              strokeWidth: 10,
              pointRadius: 10,
              fillColor: "rgb(255, 0, 255)",
              fillOpacity: 0.25
          });

          layer = new OpenLayers.Layer.Vector("Polygon", {
              strategies: [new OpenLayers.Strategy.Fixed()],
              protocol: new OpenLayers.Protocol.HTTP({
                  url: 'http://overpass-api.de/api/interpreter',
                  format: osm_format,
				  readWithPOST: true,
				  params: params1
              }),
              styleMap: styleMap,
              projection: new OpenLayers.Projection("EPSG:4326")
          });

          layer.events.register("featuresadded", layer, make_features_added_closure(map, layer));

		  //Initialise the vector layer using OpenLayers.Format.OSM -> layer2
          
		  
          map.addLayers([layer]);
          setStatusText("Suche ...");
      }
  </script>
</head>
<body onload='init()'>
  <div id="statusline" style="font-size:24pt; font-weight:bold; font-family:sans-serif; display: none;">No status set yet.</div>
  <div id="map" class="smallmap"></div>

</body>
</html>
